تقمّص دور Senior Software Architect متخصص في توليد التقارير العربية الاحترافية (RTL + Arabic shaping + PDF rendering)، بخبرة عميقة في أنظمة التصدير، المتصفحات عديمة الواجهة (Headless Browsers)، ومعالجة النصوص العربية.

السياق

لدينا تطبيق ويب يُولّد تقريرًا عربيًا غنيًا بالمحتوى (RTL، فقرات طويلة، عناوين، نسب مئوية، عناصر UI).
تم استخدام @react-pdf/renderer سابقًا، ونتج عنه تلف كامل في النصوص العربية داخل PDF (رموز مشوّهة، Encoding مكسور، فشل في الخطوط).

الهدف غير القابل للتفاوض

إنشاء حل جذري ونهائي 100% لتوليد ملفات PDF عربية:

نص عربي سليم تمامًا

RTL صحيح

Arabic shaping + ligatures طبيعي

خطوط عربية مضمنة بشكل ثابت

مخرجات مطابقة لما يظهر في المتصفح

بدون أي اعتماد على react-pdf أو PDFKit

القيود الصارمة (NON-NEGOTIABLE)

❌ يُمنع استخدام:

@react-pdf/renderer

PDFKit

jsPDF

أي مكتبة لا تعتمد على متصفح حقيقي

✅ يجب استخدام:

HTML → PDF عبر Headless Chrome (Puppeteer)

يجب أن يكون الحل:

Server-side

Stable داخل بيئات sandbox مثل Replit

قابل للتوسع لاحقًا

المطلوب منك بالتفصيل

قدّم الحل ملفًا ملفًا وبالترتيب الصحيح، مع كود كامل وجاهز للتنفيذ يشمل:

معمارية الحل

Flow واضح: Frontend → Backend → HTML Template → Puppeteer → PDF

شرح مختصر لماذا هذا الحل يعمل للعربية

ملفات التنفيذ

server/report-template.html
(HTML كامل للتقرير مع dir="rtl" و lang="ar" وخط عربي مضمّن)

server/report.css
(تنسيق احترافي متوافق مع PDF)

server/pdf.service.ts
(كود Puppeteer لتوليد PDF مع:

تحميل الخط محليًا

ضبط viewport

انتظار تحميل الخطوط

تصدير PDF بجودة عالية)

Endpoint API:

/api/export-report-pdf

الخطوط

استخدام خط عربي احترافي (مثل Cairo أو Noto Arabic)

تضمين الخط محليًا داخل المشروع (NO CDN)

التعامل مع Replit / iframe

إعادة ملف PDF كـ application/pdf

أو فتحه في تبويب جديد إذا لزم

اختبارات إلزامية

فقرة عربية طويلة

أرقام ونسب مئوية

عناوين

نص عربي + إنجليزي مختلط

التأكد أن الناتج PDF مطابق 100% لما يظهر في الواجهة

أسلوب الإخراج المطلوب

كود نظيف، مباشر، بلا حشو

كل ملف بعنوان واضح

لا تشرح بديهيات

لا تقترح بدائل

هذا حل نهائي Production-grade

النتيجة المتوقعة

نظام تصدير PDF عربي:

مستقر

احترافي

صالح للاستخدام التجاري

لا ينهار مع النصوص العربية

ولا يحتاج أي ترقيع مستقبلي